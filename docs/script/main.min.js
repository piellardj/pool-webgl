!function(){"use strict";var e={531:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.bindRendererChooser=t.bind=void 0,r(457),t.bind=function(e,t,r){!function(e,t,r){var n="quality",i=function(t){var r=+t[0];e.reset(r,r)};Page.Tabs.addObserver(n,i),i(Page.Tabs.getValues(n));var o="rain-checkbox-id",a=function(t){e.rain=t};Page.Checkbox.addObserver(o,a),a(Page.Checkbox.isChecked(o));var u="surface-tension-range-id",s=function(t){e.surfaceTension=t};Page.Range.addObserver(u,s),s(Page.Range.getValue(u));var c="stiffness-range-id",l=function(t){e.springStiffness=t};Page.Range.addObserver(c,l),l(Page.Range.getValue(c));var f="dispersion-range-id",d=function(t){e.dispersion=t};Page.Range.addObserver(f,d),d(Page.Range.getValue(f));var h="specular-checkbox-id",p=function(e){t.specular=e,r.specular=e};Page.Checkbox.addObserver(h,p),p(Page.Checkbox.isChecked(h));var _="caustics-checkbox-id",v=function(e){t.caustics=e,r.caustics=e};Page.Checkbox.addObserver(_,v),v(Page.Checkbox.isChecked(_));var m="fresnel-checkbox-id";p=function(e){t.fresnel=e,r.fresnel=e},Page.Checkbox.addObserver(m,p),p(Page.Checkbox.isChecked(m));var g="amplitude-range-id",y=function(e){t.amplitude=e,r.amplitude=e};Page.Range.addObserver(g,y),y(Page.Range.getValue(g));var b="level-range-id",E=function(e){t.waterLevel=e,r.waterLevel=e};Page.Range.addObserver(b,E),E(Page.Range.getValue(b));var T="opacity-range-id",R=function(e){t.opacity=e,r.opacity=e};Page.Range.addObserver(T,R),R(Page.Range.getValue(T));var C="refraction-range-id",x=function(e){t.eta=e,r.eta=e};Page.Range.addObserver(C,x),x(Page.Range.getValue(C))}(e,t,r)},t.bindRendererChooser=function(e,t){function r(r){"2D"===r[0]?e():t()}var n="viewer";Page.Tabs.addObserver(n,r),r(Page.Tabs.getValues(n))}},72:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i.id=t.createFramebuffer(),i.width=r,i.height=n,i}return i(t,e),t.prototype.bind=function(t,r){void 0===r&&(r=null);var n=e.prototype.gl.call(this);n.bindFramebuffer(n.FRAMEBUFFER,this.id),n.viewport(0,0,this.width,this.height);for(var i=0;i<t.length;++i)n.framebufferTexture2D(n.FRAMEBUFFER,n["COLOR_ATTACHMENT"+i],n.TEXTURE_2D,t[i],0);r&&(n.bindRenderbuffer(n.RENDERBUFFER,r),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,r))},t.bindDefault=function(e,t){void 0===t&&(t=null),e.bindFramebuffer(e.FRAMEBUFFER,null),null===t?e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight):e.viewport(t.left,t.lower,t.width,t.height)},t.prototype.freeGLResources=function(){e.prototype.gl.call(this).deleteFramebuffer(this.id),this.id=null},t}(o(r(771)).default);t.default=a},771:function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this._gl=e}return e.prototype.gl=function(){return this._gl},e}();t.default=r},490:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=o(r(771));function u(e,t,r){alert("NOT IMPLEMENTED YET")}var s={35664:{str:"FLOAT_VEC2",binder:function(e,t,r){e.uniform2fv(t,r)}},35665:{str:"FLOAT_VEC3",binder:function(e,t,r){e.uniform3fv(t,r)}},35666:{str:"FLOAT_VEC4",binder:function(e,t,r){e.uniform4fv(t,r)}},35667:{str:"INT_VEC2",binder:function(e,t,r){e.uniform2iv(t,r)}},35668:{str:"INT_VEC3",binder:function(e,t,r){e.uniform3iv(t,r)}},35669:{str:"INT_VEC4",binder:function(e,t,r){e.uniform4iv(t,r)}},35670:{str:"BOOL",binder:function(e,t,r){e.uniform1i(t,+r)}},35671:{str:"BOOL_VEC2",binder:function(e,t,r){e.uniform2iv(t,r)}},35672:{str:"BOOL_VEC3",binder:function(e,t,r){e.uniform3iv(t,r)}},35673:{str:"BOOL_VEC4",binder:function(e,t,r){e.uniform4iv(t,r)}},35674:{str:"FLOAT_MAT2",binder:function(e,t,r){e.uniformMatrix2fv(t,!1,r)}},35675:{str:"FLOAT_MAT3",binder:function(e,t,r){e.uniformMatrix3fv(t,!1,r)}},35676:{str:"FLOAT_MAT4",binder:function(e,t,r){e.uniformMatrix4fv(t,!1,r)}},35678:{str:"SAMPLER_2D",binder:function(e,t,r,n){e.uniform1i(t,r),e.activeTexture(e["TEXTURE"+r]),e.bindTexture(e.TEXTURE_2D,n)}},35680:{str:"SAMPLER_CUBE",binder:function(e,t,r,n){e.uniform1i(t,r),e.activeTexture(e["TEXTURE"+r]),e.bindTexture(e.TEXTURE_CUBE_MAP,n)}},5120:{str:"BYTE",binder:u},5121:{str:"UNSIGNED_BYTE",binder:u},5122:{str:"SHORT",binder:u},5123:{str:"UNSIGNED_SHORT",binder:u},5124:{str:"INT",binder:function(e,t,r){Array.isArray(r),e.uniform1iv(t,r)}},5125:{str:"UNSIGNED_INT",binder:u},5126:{str:"FLOAT",binder:function(e,t,r){Array.isArray(r)?e.uniform1fv(t,r):e.uniform1f(t,r)}}},c=function(e){function t(t,r,n){var i=this;function o(e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(console.log(t.getShaderInfoLog(n)),t.deleteShader(n),null)}(i=e.call(this,t)||this).id=null,i.uCount=0,i.aCount=0;var a=o(t.VERTEX_SHADER,r),u=o(t.FRAGMENT_SHADER,n),s=t.createProgram();return t.attachShader(s,a),t.attachShader(s,u),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?(i.id=s,i.introspection()):(console.log(t.getProgramInfoLog(s)),t.deleteProgram(s)),i}return i(t,e),t.prototype.freeGLResources=function(){e.prototype.gl.call(this).deleteProgram(this.id),this.id=null},t.prototype.introspection=function(){var t=e.prototype.gl.call(this);this.uCount=t.getProgramParameter(this.id,t.ACTIVE_UNIFORMS),this.u=[];for(var r=0;r<this.uCount;++r){var n=t.getActiveUniform(this.id,r),i=n.name;this.u[i]={value:null,loc:t.getUniformLocation(this.id,i),size:n.size,type:n.type}}for(this.aCount=t.getProgramParameter(this.id,t.ACTIVE_ATTRIBUTES),this.a=[],r=0;r<this.aCount;++r){var o=t.getActiveAttrib(this.id,r),a=o.name;this.a[a]={VBO:null,loc:t.getAttribLocation(this.id,a),size:o.size,type:o.type}}},t.prototype.use=function(){e.prototype.gl.call(this).useProgram(this.id)},t.prototype.bindUniforms=function(){var t=e.prototype.gl.call(this),r=0;for(var n in this.u){var i=this.u[n];if(null!==i.value)if(35678===i.type||35680===i.type){var o=r;s[i.type].binder(t,i.loc,o,i.value),r++}else s[i.type].binder(t,i.loc,i.value)}},t.prototype.bindAttributes=function(){for(var e in this.a){var t=this.a[e];null!==t.VBO&&t.VBO.bind(t.loc)}},t.prototype.bindUniformsAndAttributes=function(){this.bindUniforms(),this.bindAttributes()},t}(a.default);t.default=c},548:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.resizeCanvas=void 0,t.resizeCanvas=function(e,t){void 0===t&&(t=!1);var r=t?window.devicePixelRatio:1,n=e.canvas,i=Math.floor(n.clientWidth*r),o=Math.floor(n.clientHeight*r);n.width==i&&n.height==o||(n.width=i,n.height=o)}},62:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,r,n,i){var o=e.call(this,t)||this;return o.id=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o.id),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),o.size=n,o.type=i,o.normalize=!1,o.stride=0,o.offset=0,o}return i(t,e),t.prototype.freeGLResources=function(){this.gl().deleteBuffer(this.id),this.id=null},t.createQuad=function(e,r,n,i,o){return new t(e,new Float32Array([r,n,i,n,r,o,i,o]),2,e.FLOAT)},t.prototype.bind=function(t){var r=e.prototype.gl.call(this);r.enableVertexAttribArray(t),r.bindBuffer(r.ARRAY_BUFFER,this.id),r.vertexAttribPointer(t,this.size,this.type,this.normalize,this.stride,this.offset)},t}(o(r(771)).default);t.default=a},883:function(e,t){Object.defineProperty(t,"__esModule",{value:!0});t.default=function(){}},633:function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var u=o(r(548)),s=a(r(72)),c=a(r(583)),l=a(r(661)),f=a(r(718)),d=a(r(792)),h=o(r(531));r(457),function(){var e=function(e,t){function r(e){Page.Demopage.setErrorMessage("webgl-support",e)}var n=e.getContext("webgl",t);if(!n){if(!(n=e.getContext("experimental-webgl",t)))return r("Your browser or device does not seem to support WebGL."),null;r("Your browser or device only supports experimental WebGL.\nThe simulation may not run as expected.")}return n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.disable(n.BLEND),n.clearColor(0,0,0,0),u.resizeCanvas(n,!1),n}(Page.Canvas.getCanvas(),{});if(e){var t=function(e){Page.Canvas.getCanvasContainer().style.background=e?"#BCBCC6":"none"};Page.Canvas.Observers.fullscreenToggle.push(t),t(Page.Canvas.isFullScreen());var r=new c.default(e,512,512),n=new d.default(e,512,"rc/tile.png"),i=new l.default(e,n),o=new f.default(e,n);h.bind(r,i,o);var a=o;h.bindRendererChooser((function(){a=i}),(function(){a=o}));var p=0;setInterval((function(){Page.Canvas.setIndicatorText("fps",p.toFixed(0))}),1e3);var _=0,v=0;requestAnimationFrame((function t(i){p=1/((i*=.001)-v),v=i,i-_>.016666666666666666&&(_=i,a.interact(r),r.update(1/60)),u.resizeCanvas(e,!1),a.caustics&&n.caustics.compute(r,a.amplitude,a.waterLevel,a.eta),s.default.bindDefault(e),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),a.display(r,n),requestAnimationFrame(t)}))}}()},724:function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this._focus=e,this._distance=t,this._theta=0,this._phi=.01,this._eyePos=[0,0,0],this._viewMatrix=mat4.create(),this.recompute()}return Object.defineProperty(e.prototype,"focusPoint",{get:function(){return this._focus},set:function(e){this._focus=e,this.recompute()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"distance",{get:function(){return this._distance},set:function(e){this._distance=e,this.recompute()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"theta",{get:function(){return this._theta},set:function(e){this._theta=e,this.recompute()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"phi",{get:function(){return this._phi},set:function(e){this._phi=e,this.recompute()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"eyePos",{get:function(){return this._eyePos},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"viewMatrix",{get:function(){return this._viewMatrix},enumerable:!1,configurable:!0}),e.prototype.recompute=function(){var e=Math.sin,t=Math.cos;this._eyePos[0]=this.focusPoint[0]+this.distance*(e(this.phi)*t(this.theta)),this._eyePos[1]=this.focusPoint[1]+this.distance*(e(this.phi)*e(this.theta)),this._eyePos[2]=this.focusPoint[2]+this.distance*t(this.phi),this._viewMatrix=mat4.lookAt(this._viewMatrix,this.eyePos,this.focusPoint,[0,0,1])},e}();t.default=r},457:function(){},42:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildCausticsShader=void 0;var i=n(r(490)),o=r(176);t.buildCausticsShader=function(e){var t="attribute vec2 aVert;\n\nuniform sampler2D uWater;\nuniform sampler2D uNormals;\n\nuniform float uAmplitude;\nuniform float uWaterLevel;\nuniform float uEta;\n\nvarying vec2 sourceCoords;\nvarying vec2 refractedCoords;\n\n___ENCODE_DECODE___\n\nvoid main(void) {\n    float height = decodeHeight(texture2D(uWater, aVert));\n    height = uWaterLevel + 0.5 * uAmplitude * height;\n    vec3 normal = decodeNormal(texture2D(uNormals, aVert), uAmplitude);\n\n    const vec3 fromLight = vec3(0, 0, -1);\n    vec3 refracted = refract(fromLight, normal, uEta);\n    vec3 toGround = height * refracted / refracted.z;\n\n    vec2 groundCoords = aVert + toGround.xy;\n\n    sourceCoords = aVert;\n    refractedCoords = groundCoords;\n\n    gl_Position = vec4(2.0*groundCoords - 1.0, 0.0, 1.0);\n}".replace(/___ENCODE_DECODE___/g,o.encodeDecodeStr);return new i.default(e,t,"#extension GL_OES_standard_derivatives : enable\nprecision mediump float;\n\nvarying vec2 sourceCoords;\nvarying vec2 refractedCoords;\n\nvoid main(void)\n{\n    float sourceArea = length(dFdx(sourceCoords)) * length(dFdy(sourceCoords));\n    float refractedArea = length(dFdx(refractedCoords)) * length(dFdy(refractedCoords));\n\n    float variation = sourceArea / refractedArea;\n\n    gl_FragColor = 0.5 + .9 * vec4(variation - 1.0);\n}")}},814:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),u=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=s(r(771)),l=s(r(72)),f=u(r(42)),d=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i._supported=null!==t.getExtension("OES_standard_derivatives"),i._gridWidth=128,i._gridHeight=128,i.reset(r,n),i}return i(t,e),t.prototype.freeGLResources=function(){var t=e.prototype.gl.call(this);this._shader&&this._shader.freeGLResources(),this._texture&&t.deleteTexture(this._texture),this._fbo&&this._fbo.freeGLResources(),this._vertices&&t.deleteBuffer(this._vertices),this._indices&&t.deleteBuffer(this._indices)},t.prototype.compute=function(t,r,n,i){if(this.supported){var o=e.prototype.gl.call(this),a=this._shader;a.u.uWater.value=t.heightmap,a.u.uNormals.value=t.normalmap,a.u.uAmplitude.value=.1*r,a.u.uWaterLevel.value=n,a.u.uEta.value=i,this._fbo.bind([this._texture]),o.clear(o.COLOR_BUFFER_BIT),a.use(),a.bindUniforms(),o.enableVertexAttribArray(0),o.bindBuffer(o.ARRAY_BUFFER,this._vertices),o.vertexAttribPointer(0,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._indices);var u=2*(this._gridWidth-1)*(this._gridHeight-1);o.drawElements(o.TRIANGLES,3*u,o.UNSIGNED_SHORT,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),o.bindBuffer(o.ARRAY_BUFFER,null),o.disableVertexAttribArray(0)}},t.prototype.reset=function(t,r){if(this.supported){this.freeGLResources();var n=e.prototype.gl.call(this);this._width=t,this._height=r,this._shader=f.buildCausticsShader(n),this._fbo=new l.default(n,t,r);for(var i=new Array(3*t*r),o=0;o<i.length;++o)i[o]=127;var a=new Uint8Array(i),u=n.CLAMP_TO_EDGE,s=n.LINEAR;this._texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this._texture),n.texImage2D(n.TEXTURE_2D,0,n.RGB,t,r,0,n.RGB,n.UNSIGNED_BYTE,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,u);for(var c=this._gridWidth,d=this._gridHeight,h=[],p=0;p<d;++p)for(var _=0;_<c;++_)h.push(_/(c-1)),h.push(p/(d-1));var v=new Float32Array(h),m=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,m),n.bufferData(n.ARRAY_BUFFER,v,n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null),this._vertices=m;var g=[];for(p=0;p<d-1;++p)for(_=0;_<c-1;++_)g.push(p*c+_),g.push(p*c+_+1),g.push((p+1)*c+_),g.push(p*c+_+1),g.push((p+1)*c+_+1),g.push((p+1)*c+_);v=new Uint16Array(g),m=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,m),n.bufferData(n.ELEMENT_ARRAY_BUFFER,v,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),this._indices=m}},Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supported",{get:function(){return this._supported},enumerable:!1,configurable:!0}),t}(c.default);t.default=d},351:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t){return e.call(this,t)||this}return i(t,e),t.prototype.freeGLResources=function(){},Object.defineProperty(t.prototype,"specular",{get:function(){return this._showSpecular},set:function(e){this._showSpecular=e,this.updateSpecular()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"caustics",{get:function(){return this._showCaustics},set:function(e){this._showCaustics=e,this.updateCaustics()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fresnel",{get:function(){return this._useFresnel},set:function(e){this._useFresnel=e,this.updateFresnel()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"amplitude",{get:function(){return this._amplitude},set:function(e){this._amplitude=e,this.updateAmplitude()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"waterLevel",{get:function(){return this._waterLevel},set:function(e){this._waterLevel=e,this.updateWaterLevel()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"opacity",{get:function(){return this._opacity},set:function(e){this._opacity=e,this.updateOpacity()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"eta",{get:function(){return this._eta},set:function(e){this._eta=e,this.updateEta()},enumerable:!1,configurable:!0}),t}(o(r(771)).default);t.default=a},342:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildDisplayShader=void 0;var i=n(r(490)),o=n(r(62)),a=r(176);t.buildDisplayShader=function(e){var t="precision mediump float;\n\nuniform sampler2D uWater;\nuniform sampler2D uNormals;\nuniform sampler2D uCaustics;\nuniform sampler2D uTileTexture;\n\nuniform float uWaterLevel;\nuniform float uAmplitude;\nuniform float uEta;\nuniform float uOpacity;\nuniform bool uShowSpecular;\nuniform bool uShowCaustics;\n\nvarying vec2 sampleCoords;\n\n___ENCODE_DECODE___\n\nconst vec3 WATER_COLOR = vec3(0.0, 0.2, 0.5);\nconst vec3 SPECULAR_COLOR = vec3(1);\nconst float TILE_REPETITION = 4.0;\n\nvoid main(void)\n{\n    float height = decodeHeight(texture2D(uWater, sampleCoords));\n    height = uWaterLevel + 0.5 * uAmplitude * height;\n    vec3 normal = decodeNormal(texture2D(uNormals, sampleCoords), uAmplitude);\n\n    vec3 position = vec3(sampleCoords, height);\n\n    const vec3 fromEye = vec3(0, 0, -1);\n    vec3 refracted = refract(fromEye, normal, uEta);\n    refracted *= height / refracted.z;\n    vec2 coordsOnFloor = sampleCoords + refracted.xy;\n\n    vec3 tileColor = texture2D(uTileTexture, TILE_REPETITION * coordsOnFloor).rgb;\n    float caustics = texture2D(uCaustics, coordsOnFloor).r;\n    caustics = mix(0.5, caustics, float(uShowCaustics));\n    vec3 floorColor = tileColor * (0.5 + caustics);\n\n    float opacity = clamp(uOpacity * length(refracted), 0.0, 1.0);\n    vec3 color = mix(floorColor, WATER_COLOR, opacity);\n\n    // const vec3 fromLight = normalize(vec3(.05, -.1, -.8));\n    const vec3 fromLight = vec3(-.061898, -.123797, -.990405); // precomputed for IE11\n    vec3 reflected = reflect(fromLight, normal);\n    float specular = max(0.0, dot(reflected, -fromEye));\n    specular = pow(specular, 1000.0) * float(uShowSpecular);\n\n    gl_FragColor = vec4(color + specular, 1);\n}".replace(/___ENCODE_DECODE___/g,a.encodeDecodeStr),r=new i.default(e,"attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}",t);return r.a.aCorner.VBO=o.default.createQuad(e,0,0,1,1),r}},661:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),u=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=s(r(351)),l=s(r(72)),f=s(r(883)),d=u(r(342));r(457);var h=function(e){function t(t,r){var n=e.call(this,t)||this;return n._displayShader=d.buildDisplayShader(t),n._displayShader.u.uTileTexture.value=r.tileTexture,n._displayShader.u.uCaustics.value=r.caustics.texture,n._viewport=new f.default,n}return i(t,e),t.prototype.freeGLResources=function(){this._displayShader.freeGLResources()},t.prototype.updateViewport=function(){var t=e.prototype.gl.call(this),r=Math.min(t.drawingBufferWidth,t.drawingBufferHeight);this._viewport.left=.5*(t.drawingBufferWidth-r),this._viewport.lower=.5*(t.drawingBufferHeight-r),this._viewport.width=r,this._viewport.height=r},t.prototype.display=function(t,r){var n=e.prototype.gl.call(this);this.updateViewport(),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST);var i=this._displayShader;l.default.bindDefault(n,this._viewport),i.u.uWater.value=t.heightmap,i.u.uNormals.value=t.normalmap,i.use(),i.bindUniformsAndAttributes(),n.drawArrays(n.TRIANGLE_STRIP,0,4)},t.prototype.interact=function(e){if(Page.Canvas.isMouseDown()){var t=Page.Canvas.getSize(),r=Page.Canvas.getMousePosition();r[0]*=t[0],r[1]=(1-r[1])*t[1],this.updateViewport(),r[0]=(r[0]-this._viewport.left)/this._viewport.width,r[1]=(r[1]-this._viewport.lower)/this._viewport.height,e.touch(r[0]*e.width,r[1]*e.height,8)}},t.prototype.updateSpecular=function(){this._displayShader.u.uShowSpecular.value=this.specular},t.prototype.updateCaustics=function(){this._displayShader.u.uShowCaustics.value=this.caustics},t.prototype.updateFresnel=function(){},t.prototype.updateAmplitude=function(){this._displayShader.u.uAmplitude.value=this.amplitude},t.prototype.updateWaterLevel=function(){this._displayShader.u.uWaterLevel.value=this.waterLevel},t.prototype.updateOpacity=function(){this._displayShader.u.uOpacity.value=this.opacity},t.prototype.updateEta=function(){this._displayShader.u.uEta.value=this.eta},t}(c.default);t.default=h},551:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildSurfaceShader=t.buildSidesShader=void 0;var i=n(r(490)),o=r(176),a="\nuniform sampler2D uCaustics;\nuniform sampler2D uTileTexture;\n\nuniform vec3 uLightDir; //normalized\n\nuniform float uF0;\nuniform float uEta;\nuniform float uOpacity;\nuniform bool uSpecular;\nuniform bool uShowCaustics;\nuniform bool uFresnel;\n\nconst vec3 WATER_COLOR = vec3(0.0, 0.2, 0.5);\nconst vec3 SPECULAR_COLOR = vec3(1);\nconst float TILE_REPETITION = 4.0;\n\n/* Fresnel factor describes the proportion of refracted and reflected.\n* Arguments expected to be normalized. */\nfloat getFresnelFactor(const vec3 normal, const vec3 fromEye)\n{\n    float computed = mix(pow(1.0 - dot(normal,-fromEye), 5.0), 1.0, uF0);\n    return min(float(uFresnel), computed);\n}\n\nvec3 getTileColor(const vec2 coords)\n{\n    return texture2D(uTileTexture, TILE_REPETITION * coords).rgb;\n}\n\nfloat getCaustics(const vec2 coords)\n{\n    return mix(0.5, texture2D(uCaustics, coords).r, float(uShowCaustics));\n}\n\nvec3 getFloorColor(const vec2 coords)\n{\n    if (any(lessThan(coords, vec2(0))) || any(greaterThan(coords, vec2(1)))) {\n        return vec3(0);\n    }\n\n    return getTileColor(coords) * (0.5 + getCaustics(coords));\n}\n\n/* Floor color mixed with opacity.\n* 'refracted' expected to be normalized. */\nvec3 getRefractedColor(const vec3 entryPoint, vec3 refracted)\n{\n    if (refracted.z >= 0.0) {\n        return WATER_COLOR;\n    }\n\n    refracted *= -entryPoint.z / refracted.z;\n\n    vec2 groundCoords = entryPoint.xy + refracted.xy;\n    vec3 floorColor = getFloorColor(groundCoords + .5);\n\n    /*float f = 1.0;\n\n    if (groundCoords.x < -.5) {\n        f = min(f, abs((-.5 - entryPoint.x) / (groundCoords.x - entryPoint.x)));\n    }\n    if (groundCoords.x > .5) {\n        f = min(f, abs((.5 - entryPoint.x) / (groundCoords.x - entryPoint.x)));\n    }\n    if (groundCoords.y < -.5) {\n        f = min(f, abs((-.5 - entryPoint.y) / (groundCoords.y - entryPoint.y)));\n    }\n    if (groundCoords.y > .5) {\n        f = min(f, abs((.5 - entryPoint.y) / (groundCoords.y - entryPoint.y)));\n    }\n\n    refracted *= f;*/\n\n    float opacity = uOpacity * entryPoint.z;//length(refracted);\n    opacity = clamp(opacity, 0.0, 1.0);\n\n    return mix(floorColor, WATER_COLOR, opacity);\n}\n\nvec3 getReflectedColor(const vec3 dir)\n{\n    return vec3(0.5, 0.5, 0.8);\n}\n\nvec4 getSpecular(const vec3 reflected)\n{\n    float f = max(0.0, dot(-uLightDir, reflected));\n    f = pow(f, 200.0);\n    f *= float(uSpecular);\n\n    return vec4(SPECULAR_COLOR, f);\n}\n\nvec3 computeColor(const vec3 pos, const vec3 fromEye, const vec3 normal)\n{\n    vec3 refracted = refract(fromEye, normal, uEta);\n    vec3 reflected = reflect(fromEye, normal);\n\n    vec3 refractedColor = getRefractedColor(pos, refracted);\n    vec3 reflectedColor = getReflectedColor(reflected);\n\n    float fresnelFactor = getFresnelFactor(fromEye, normal);\n\n    vec3 surfaceColor = mix(refractedColor, reflectedColor, fresnelFactor);\n    vec4 specularColor = getSpecular(reflected);\n\n    return mix(surfaceColor, specularColor.rgb, specularColor.a);\n}";t.buildSidesShader=function(e){var t="precision mediump float;\n\nuniform sampler2D uWater;\n\nuniform vec3 uEyePos;\n\nvarying vec3 vPosition;\nvarying vec2 vNormal;\nvarying float relativeHeight; //relative to amplitude, in [-1, +1]\n\n___ENCODE_DECODE___\n\n___WATER_COMMON___\n\n/* Returns true for every fragment above the water level */\nbool shouldSkip()\n{\n    float surface = decodeHeight(texture2D(uWater, vPosition.xy + .5));\n    return (relativeHeight > surface);\n}\n\nvoid main(void)\n{\n    /* Skip the fragments above water level */\n    if (shouldSkip()) {\n        discard;\n    }\n\n    vec3 fromEye = normalize(vPosition - uEyePos);\n    vec3 normal = vec3(vNormal, 0); //already normalized\n    \n    vec3 color = computeColor(vPosition, fromEye, normal);\n\n    gl_FragColor = vec4(color, 1);\n}".replace(/___ENCODE_DECODE___/g,o.encodeDecodeStr);return t=t.replace(/___WATER_COMMON___/g,a),new i.default(e,"attribute vec3 aPosition; //in {-.5, +.5} x {-.5, +.5} x {+0, +1}\nattribute vec2 aNormal; //normalized in {-1, +1} x {-1, +1}\n\nuniform mat4 uMVPMatrix;\n\nuniform float uWaterLevel;\nuniform float uAmplitude;\n\nvarying vec3 vPosition;\nvarying vec2 vNormal;\nvarying float relativeHeight; //relative to amplitude, in [-1, +1]\n\nvoid main(void) {\n    float dH = uAmplitude / 2.0;\n\n    vPosition = aPosition;\n    vPosition.z *= uWaterLevel + dH;\n\n    vNormal = aNormal;\n\n    relativeHeight = (vPosition.z - uWaterLevel) / dH;\n    \n    gl_Position = uMVPMatrix * vec4(vPosition, 1.0);\n}",t)},t.buildSurfaceShader=function(e){var t="attribute vec2 aSampleCoords; //in [0,1] x [0,1]\n\nuniform mat4 uMVPMatrix;\n\nuniform sampler2D uWater;\nuniform sampler2D uNormals;\n\nuniform float uWaterLevel;\nuniform float uAmplitude;\n\nvarying vec3 vPosition;\nvarying vec3 vNormal;\n\n___ENCODE_DECODE___\n\nvoid main(void) {\n    float height = decodeHeight(texture2D(uWater, aSampleCoords));\n\n    float dH = uAmplitude / 2.0;\n\n    vPosition.xy = aSampleCoords - .5;\n    vPosition.z = uWaterLevel + dH * height;\n    vPosition.z -= 0.001; //slight shift to avoid artifacts at surface-sides jointure\n\n    vNormal = decodeNormal(texture2D(uNormals, aSampleCoords), uAmplitude);\n    \n    gl_Position = uMVPMatrix * vec4(vPosition, 1.0);\n}".replace(/___ENCODE_DECODE___/g,o.encodeDecodeStr),r="precision mediump float;\n\nuniform vec3 uEyePos;\n\nvarying vec3 vPosition;\nvarying vec3 vNormal;\n\n___WATER_COMMON___\n\nvoid main(void)\n{\n    vec3 fromEye = normalize(vPosition - uEyePos);\n    vec3 normal = normalize(vNormal);\n\n    vec3 color = computeColor(vPosition, fromEye, normal);\n\n    gl_FragColor = vec4(color, 1);\n}".replace(/___WATER_COMMON___/g,a);return new i.default(e,t,r)}},718:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),u=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=s(r(351)),l=u(r(551)),f=s(r(724));r(457);var d=function(e){function t(t,r){var n=e.call(this,t)||this,i=t.canvas;n._pMatrix=mat4.create(),n._mvpMatrix=mat4.create(),mat4.perspective(n._pMatrix,45,i.clientWidth/i.clientHeight,.1,100),n._camera=new f.default([0,0,n.waterLevel-.5],1.7),n._camera.theta=0,n._camera.phi=.8,n._lightDirection=vec3.fromValues(1,0,-1),vec3.normalize(n._lightDirection,n._lightDirection),n.initSurface(256,256),n.init();for(var o=0,a=[n._sidesShader,n._surfaceShader];o<a.length;o++){var u=a[o];u.u.uTileTexture.value=r.tileTexture,u.u.uCaustics.value=r.caustics.texture,u.u.uLightDir.value=n._lightDirection}return Page.Canvas.Observers.mouseDrag.push((function(e,t){n._camera.theta-=3.14159*e,n._camera.phi-=1*t,n._camera.phi=Math.min(1.2,Math.max(1e-6,n._camera.phi)),n.updateMVPMatrix()})),Page.Canvas.Observers.mouseWheel.push((function(e){var t=n._camera.distance+.2*e;t=Math.min(3,Math.max(1.42,t)),n._camera.distance=t,n.updateMVPMatrix()})),n}return i(t,e),t.prototype.updatePMatrix=function(){var t=e.prototype.gl.call(this).canvas;mat4.perspective(this._pMatrix,45,t.clientWidth/t.clientHeight,.1,100)},t.prototype.updateMVPMatrix=function(){this.updatePMatrix(),mat4.multiply(this._mvpMatrix,this._pMatrix,this._camera.viewMatrix)},t.prototype.initSurface=function(t,r){var n=e.prototype.gl.call(this);this._gridWidth=t,this._gridHeight=r;for(var i=this._gridWidth,o=this._gridHeight,a=[],u=0;u<o;++u)for(var s=0;s<i;++s)a.push(s/(i-1)),a.push(u/(o-1));var c=new Float32Array(a),l=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,l),n.bufferData(n.ARRAY_BUFFER,c,n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null),this._gridVertices=l;var f=[];for(u=0;u<o-1;++u)for(s=0;s<i-1;++s)f.push(u*i+s),f.push(u*i+s+1),f.push((u+1)*i+s),f.push(u*i+s+1),f.push((u+1)*i+s+1),f.push((u+1)*i+s);c=new Uint16Array(f),l=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,l),n.bufferData(n.ELEMENT_ARRAY_BUFFER,c,n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),this._gridIndices=l},t.prototype.freeGLResources=function(){var t=e.prototype.gl.call(this);t.deleteBuffer(this._vertices),t.deleteBuffer(this._normals),this._sidesShader.freeGLResources(),this._surfaceShader.freeGLResources(),t.deleteBuffer(this._gridVertices),t.deleteBuffer(this._gridIndices)},t.prototype.display=function(t,r){var n=e.prototype.gl.call(this);this._sidesShader.u.uEyePos.value=this._camera.eyePos,this._surfaceShader.u.uEyePos.value=this._camera.eyePos,this.updateMVPMatrix(),n.enable(n.CULL_FACE),n.enable(n.DEPTH_TEST),this.displaySides(t),this.displaySurface(t)},t.prototype.interact=function(e){},t.prototype.displaySides=function(t){var r=e.prototype.gl.call(this),n=this._sidesShader;n.u.uWater.value=t.heightmap,n.use(),n.bindUniforms(),r.enableVertexAttribArray(0),r.bindBuffer(r.ARRAY_BUFFER,this._vertices),r.vertexAttribPointer(0,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(1),r.bindBuffer(r.ARRAY_BUFFER,this._normals),r.vertexAttribPointer(1,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLES,0,24),r.disableVertexAttribArray(1),r.disableVertexAttribArray(0)},t.prototype.displaySurface=function(t){var r=e.prototype.gl.call(this),n=this._surfaceShader;n.u.uWater.value=t.heightmap,n.u.uNormals.value=t.normalmap,n.use(),n.bindUniforms(),r.enableVertexAttribArray(0),r.bindBuffer(r.ARRAY_BUFFER,this._gridVertices),r.vertexAttribPointer(0,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._gridIndices);var i=2*(this._gridWidth-1)*(this._gridHeight-1);r.drawElements(r.TRIANGLES,3*i,r.UNSIGNED_SHORT,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,null),r.disableVertexAttribArray(0)},t.prototype.init=function(){var t=e.prototype.gl.call(this);this._sidesShader=l.buildSidesShader(t),this._sidesShader.u.uMVPMatrix.value=this._mvpMatrix,this._surfaceShader=l.buildSurfaceShader(t),this._surfaceShader.u.uMVPMatrix.value=this._mvpMatrix;var r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([.5,-.5,1,-.5,-.5,1,-.5,-.5,0,.5,-.5,1,-.5,-.5,0,.5,-.5,0,.5,.5,1,.5,-.5,1,.5,-.5,0,.5,.5,1,.5,-.5,0,.5,.5,0,.5,.5,1,-.5,.5,0,-.5,.5,1,-.5,.5,0,.5,.5,1,.5,.5,0,-.5,-.5,1,-.5,.5,1,-.5,-.5,0,-.5,-.5,0,-.5,.5,1,-.5,.5,0]),t.STATIC_DRAW),this._vertices=r,r=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,1,0,1,0,1,0,1,0,1,0,1,0,0,1,0,1,0,1,0,1,0,1,0,1,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0]),t.STATIC_DRAW),this._normals=r},t.prototype.updateSpecular=function(){this._sidesShader.u.uSpecular.value=this.specular,this._surfaceShader.u.uSpecular.value=this.specular},t.prototype.updateCaustics=function(){this._sidesShader.u.uShowCaustics.value=this.caustics,this._surfaceShader.u.uShowCaustics.value=this.caustics},t.prototype.updateFresnel=function(){this._sidesShader.u.uFresnel.value=this.fresnel,this._surfaceShader.u.uFresnel.value=this.fresnel},t.prototype.updateAmplitude=function(){var e=5*this.amplitude;this._sidesShader.u.uAmplitude.value=e,this._surfaceShader.u.uAmplitude.value=e},t.prototype.updateWaterLevel=function(){this._sidesShader.u.uWaterLevel.value=this.waterLevel,this._surfaceShader.u.uWaterLevel.value=this.waterLevel,this._camera.focusPoint=[0,0,this.waterLevel-.5],this.updateMVPMatrix()},t.prototype.updateOpacity=function(){this._sidesShader.u.uOpacity.value=this.opacity,this._surfaceShader.u.uOpacity.value=this.opacity},t.prototype.updateEta=function(){this._sidesShader.u.uEta.value=this.eta,this._surfaceShader.u.uEta.value=this.eta;var e=(1-this.eta)/(1+this.eta);e*=e,this._sidesShader.u.uF0.value=e,this._surfaceShader.u.uF0.value=e},t}(c.default);t.default=d},792:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=o(r(771)),u=o(r(814)),s=function(e){function t(t,r,n){var i=this;function o(e){return"number"!=typeof e?"Not a number":e&&0==(e&e-1)}(i=e.call(this,t)||this)._caustics=new u.default(t,r,r),i._tileTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i._tileTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));var a=new Image,s=i._tileTexture;return a.onload=function(){t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a),o(a.width)&&o(a.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR))},a.src=n,i}return i(t,e),t.prototype.freeGLResources=function(){var t=e.prototype.gl.call(this);this._caustics.freeGLResources(),this._caustics=null,t.deleteTexture(this._tileTexture),this._tileTexture=null},Object.defineProperty(t.prototype,"caustics",{get:function(){return this._caustics},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tileTexture",{get:function(){return this._tileTexture},enumerable:!1,configurable:!0}),t}(a.default);t.default=s},176:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildNormalsShader=t.buildUpdateShader=t.buildTouchShader=t.encodeDecodeStr=void 0;var i=n(r(490)),o=n(r(62)),a="const float HEIGHT_RANGE = 1.0;\nconst float VEL_RANGE = 0.25;\n\nstruct Cell {\n    float h; //height\n    float v; //velocity\n};\n\n/* Decodes a float value (16 bits in [0,1])\n * from a 2D value (2x8bits in [0,1]x[0,1]) */\nfloat decode16bit(vec2 v)\n{\n    const vec2 weights = 255.0 * vec2(256.0, 1.0) / (256.0*256.0 - 1.0);\n    return dot(weights, v);\n}\n\n/* Encodes a float value (16 bits in [0,1])\n * into a 2D value (2x8bits in [0,1]x[0,1]) */\nvec2 encode16bit(float f)\n{\n    const vec2 base = (256.0*256.0 - 1.0) / vec2(256.0, 1.0);\n    return floor(mod(f * base, 256.0)) / 255.0;\n}\n\nfloat decode(vec2 v, float range)\n{\n    return (2.0 * decode16bit(v) - 1.0) * range;\n}\n\nvec2 encode(float value, float range)\n{\n    return encode16bit(0.5 * value / range + 0.5);\n}\n\nfloat decodeHeight(vec4 texel)\n{\n    return decode(texel.rg, HEIGHT_RANGE);\n}\nvec2 encodeHeight(float h)\n{\n    return encode(h, HEIGHT_RANGE);\n}\n\nvec3 decodeNormal(vec4 texel, float amplitude)\n{\n    vec3 result = 2.0 * texel.rgb - 1.0;\n    return normalize(result * vec3(amplitude, amplitude, 1));\n}\nvec4 encodeNormal(vec3 n)\n{\n    return vec4(0.5 * n + 0.5, 1);\n}\n\nfloat decodeVelocity(vec4 texel)\n{\n    return decode(texel.ba, VEL_RANGE);\n}\nvec2 encodeVelocity(float h)\n{\n    return encode(h, VEL_RANGE);\n}\n\nCell decodeCell(vec4 texel)\n{\n    return Cell(decodeHeight(texel), decodeVelocity(texel));\n}\nvec4 encodeCell(Cell cell)\n{\n    return vec4(encodeHeight(cell.h), encodeVelocity(cell.v));\n}";t.encodeDecodeStr=a,t.buildTouchShader=function(e){var t="precision mediump float;\n\nuniform sampler2D uWater;\n\nuniform vec2 uCoords;\nuniform vec2 uSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODE_DECODE___\n\nvoid main(void) {\n    Cell cell = decodeCell(texture2D(uWater, sampleCoords));\n\n    float dist = length((sampleCoords - uCoords) / uSize);\n    dist = clamp(dist, 0.0, 1.0);\n\n    cell.h = mix(-0.6*HEIGHT_RANGE, cell.h, smoothstep(0.0, 1.0, dist));\n    cell.v *= step(1.0, dist);\n\n    gl_FragColor = encodeCell(cell);\n}".replace(/___ENCODE_DECODE___/g,a),r=new i.default(e,"attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}",t);return r.a.aCorner.VBO=o.default.createQuad(e,0,0,1,1),r},t.buildUpdateShader=function(e){var t="precision mediump float;\n\nuniform sampler2D uPrevWater;\n\nuniform float uDt;\nuniform vec2 uTexelSize;\n\nuniform float uC; //surface tension\nuniform float uK; // vertical spring's stiffness\nuniform float uF; //friction\n\nvarying vec2 sampleCoords;\n\n___ENCODE_DECODE___\n\nvoid main(void) {\n    Cell cell = decodeCell(texture2D(uPrevWater, sampleCoords));\n\n    float neighbours = decodeHeight(texture2D(uPrevWater, sampleCoords + vec2(uTexelSize.x, 0))) +\n        decodeHeight(texture2D(uPrevWater, sampleCoords - vec2(uTexelSize.x, 0))) +\n        decodeHeight(texture2D(uPrevWater, sampleCoords + vec2(0, uTexelSize.y))) +\n        decodeHeight(texture2D(uPrevWater, sampleCoords - vec2(0, uTexelSize.y)));\n    neighbours *= 0.25;\n\n    /* Update velocity */\n    cell.v += -uDt * uK * cell.h; //vertical spring\n    cell.v += uDt * uC * (neighbours - cell.h); //surface tension\n    cell.v *= uF; //attenuation\n\n    /* Update position */\n    cell.h += uDt * cell.v;\n\n    gl_FragColor = encodeCell(cell);\n}".replace(/___ENCODE_DECODE___/g,a),r=new i.default(e,"attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}",t);return r.a.aCorner.VBO=o.default.createQuad(e,0,0,1,1),r},t.buildNormalsShader=function(e){var t="precision mediump float;\n\nuniform sampler2D uWater;\n\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODE_DECODE___\n\n/* Returns the normal, assuming the amplitude is 1. */\nvec3 computeNormal(vec2 coords)\n{\n    float dZx = decodeHeight(texture2D(uWater, coords + vec2(uTexelSize.x, 0))) -\n                decodeHeight(texture2D(uWater, coords - vec2(uTexelSize.x, 0)));\n    \n    float dZy = decodeHeight(texture2D(uWater, coords + vec2(0, uTexelSize.y))) -\n                decodeHeight(texture2D(uWater, coords - vec2(0, uTexelSize.y)));\n    \n    vec3 normal = cross(vec3(uTexelSize.x, 0, dZx), vec3(0, uTexelSize.y, dZy));\n    normal.xy *= 0.4 * HEIGHT_RANGE;\n\n    return normalize(normal);\n}\n\nvoid main(void) {\n    vec3 normal = computeNormal(sampleCoords);\n\n    gl_FragColor = encodeNormal(normal);\n}".replace(/___ENCODE_DECODE___/g,a),r=new i.default(e,"attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}",t);return r.a.aCorner.VBO=o.default.createQuad(e,0,0,1,1),r}},583:function(e,t,r){var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),u=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&o(t,e,r);return a(t,e),t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=s(r(771)),l=s(r(72)),f=u(r(176)),d=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i._FBO=new l.default(t,r,n),i._touchShader=f.buildTouchShader(t),i._updateShader=f.buildUpdateShader(t),i._normalsShader=f.buildNormalsShader(t),i.surfaceTension=20,i.springStiffness=.1,i.dispersion=.999,i.rain=!0,i.reset(r,n),i}return i(t,e),t.prototype.freeGLResources=function(){this._FBO&&this._FBO.freeGLResources(),this.freeTextures(),this.freeShaders()},t.prototype.freeTextures=function(){var t=e.prototype.gl.call(this);this._normalsTex&&t.deleteTexture(this._normalsTex),this._heightmapsTex&&(t.deleteTexture(this._heightmapsTex[0]),t.deleteTexture(this._heightmapsTex[1]))},t.prototype.freeShaders=function(){this._touchShader&&this._touchShader.freeGLResources(),this._updateShader&&this._updateShader.freeGLResources()},t.prototype.update=function(e){var t=this.gl();t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),this.rain&&Math.random()<.1&&this.touch(Math.random()*this.width,Math.random()*this.height,8);var r=this._updateShader;r.u.uPrevWater.value=this.currHeightmap,r.u.uDt.value=10*e,this._FBO.bind([this.nextHeightmap]),r.use(),r.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.switchHeightmaps(),this.computeNormals()},t.prototype.computeNormals=function(){var e=this.gl(),t=this._normalsShader;t.u.uWater.value=this.currHeightmap,this._FBO.bind([this._normalsTex]),t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},t.prototype.touch=function(e,t,r){var n=this.gl(),i=this._touchShader;i.u.uWater.value=this.currHeightmap,i.u.uCoords.value=[e/this.width,t/this.height],i.u.uSize.value=[r/this.width,r/this.height],this._FBO.bind([this.nextHeightmap]),i.use(),i.bindUniformsAndAttributes(),n.drawArrays(n.TRIANGLE_STRIP,0,4),this.switchHeightmaps(),this.computeNormals()},Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"surfaceTension",{get:function(){return this._surfaceTension},set:function(e){this._surfaceTension=e,this._updateShader.u.uC.value=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"springStiffness",{get:function(){return this._springStiffness},set:function(e){this._springStiffness=e,this._updateShader.u.uK.value=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dispersion",{get:function(){return this._dispersion},set:function(e){this._dispersion=e,this._updateShader.u.uF.value=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"heightmap",{get:function(){return this._heightmapsTex[this._currIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalmap",{get:function(){return this._normalsTex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currHeightmap",{get:function(){return this._heightmapsTex[this._currIndex]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nextHeightmap",{get:function(){return this._heightmapsTex[(this._currIndex+1)%2]},enumerable:!1,configurable:!0}),t.prototype.switchHeightmaps=function(){this._currIndex=(this._currIndex+1)%2},t.prototype.reset=function(t,r){this.freeTextures();var n=e.prototype.gl.call(this);this._width=t,this._height=r,this._FBO.width=t,this._FBO.height=r,this._updateShader.u.uTexelSize.value=[1/t,1/r],this._normalsShader.u.uTexelSize.value=[1/t,1/r];for(var i=new Array(4*t*r),o=0;o<i.length;++o)i[o]=127;var a=new Uint8Array(i),u=n.REPEAT,s=n.LINEAR,c=[];for(o=0;o<2;++o){var l=n.createTexture();n.bindTexture(n.TEXTURE_2D,l),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t,r,0,n.RGBA,n.UNSIGNED_BYTE,a),c.push(l)}l=n.createTexture(),n.bindTexture(n.TEXTURE_2D,l),n.texImage2D(n.TEXTURE_2D,0,n.RGB,t,r,0,n.RGB,n.UNSIGNED_BYTE,a),c.push(l);for(var f=0,d=c;f<d.length;f++){var h=d[f];n.bindTexture(n.TEXTURE_2D,h),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,u)}this._normalsTex=c[2],this._heightmapsTex=[c[0],c[1]],this._currIndex=0,this.computeNormals()},t}(c.default);t.default=d}},t={};!function r(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,r),o.exports}(633)}();
//# sourceMappingURL=main.min.js.map